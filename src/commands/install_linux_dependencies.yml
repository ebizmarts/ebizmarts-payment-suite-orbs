description: >
  Install system dependencies

parameters:
  extensions_to_install:
    type: string
    default: "bcmath gd intl mcrypt opcache pdo_mysql soap xsl zip"
  libraries_to_install:
    type: string
    default: "libicu-dev libjpeg-dev libmcrypt-dev libpng-dev libwebp-dev libxml2-dev libxpm-dev libxslt-dev libz-dev libzip-dev zlib1g-dev"
steps:
  - run:
      name: Update linux packages
      command: sudo apt-get update -qq || sudo apt-get update -qq
  - run:
      name: Set PHP Memory to 1G
      command: <<include(src/scripts/set_memory_limit_1g.sh)>>
  - run:
      name: Install required system libraries
      environment:
        PARAM_LIBRARIES_TO_INSTALL: << parameters.libraries-to-install >>
      command: <<include(src/scripts/install_sys_libs.sh)>>
  - run:
      name: Configure PHP extensions
      command: <<include(src/scripts/config_php_exts.sh)>>
  - run:
      name: Install PHP extensions
      environment:
        PARAM_EXTENSIONS_TO_INSTALL: << parameters.extensions-to-install >>
      command: <<include(src/scripts/install_php_exts.sh)>>
  - run:
      name: Install MariaDB client
      command: sudo apt-get install -qq -y mariadb-client
  - run:
      name: Add magento2.dev to hosts file
      command: echo 127.0.0.1 magento2.dev | sudo tee -a /etc/hosts
  - run:
      name: Download Magento 2 web server configuration file
      command: wget --quiet $MAGENTO_WEB_SERVER_CONF
  - run:
      name: Copy Magento 2 web server configuration file
      command: <<include(src/scripts/cp_apache_config.sh)>>
  - run:
      name: Run sed on apache environment vars
      command: sudo sed -i 's/www-data/circleci/g' /etc/apache2/envvars
  - run:
      name: Restart apache
      command: sudo service apache2 restart
  - run:
      name: Import database dump
      command: <<include(src/scripts/import_db_dump.sh)>>
