description: >
  Download files and tools required

parameters:
  version:
    type: string
    default: ""

steps:
  - run:
      name: Download PHP Unit
      command: wget --no-check-certificate https://phar.phpunit.de/phpunit-$PHP_UNIT_VERSION.phar && chmod +x phpunit-$PHP_UNIT_VERSION.phar
  - run:
      name: Decompress Magento
      command: tar xpf Magento<< parameters.version >>-PreCompiled.tar.gz
  - run:
      name: Move Magento files
      command: mv magento2/* .
  - run:
      name: Delete tar
      command: rm Magento<< parameters.version >>-PreCompiled.tar.gz
  - run:
      name: Delete old code
      command: rm -rf app/code/Ebizmarts
  - run:
      name: Download magento Composer auth.json file
      command: wget --quiet $MAGENTO_COMPOSER_AUTH
  - run:
      name: Set bin/magento as executable
      command: chmod +x bin/magento
  - checkout:
      path: app/code/Ebizmarts/SagePaySuite
  - run:
      name: Create folder for Opayo
      command: mkdir -p dev/tests/integration/testsuite/Ebizmarts/SagePaySuite/_files
  - run:
      name: Copy Api test data files to folder
      command: cp -r app/code/Ebizmarts/SagePaySuite/Test/Api/_files/* dev/tests/integration/testsuite/Ebizmarts/SagePaySuite/_files
  - run:
      name: Copy php unit config file
      command: cp app/code/Ebizmarts/SagePaySuite/phpunit_config.xml dev/tests/unit/phpunit.xml
  - run:
      name: Copy integration tests config file
      command: cp app/code/Ebizmarts/SagePaySuite/phpunit_config_integration.xml dev/tests/integration/phpunit.xml
  - run:
      name: Copy api functional config file
      command: cp app/code/Ebizmarts/SagePaySuite/phpunit_config_functional.xml dev/tests/api-functional/phpunit.xml
